#
# Module 'Commvault.Policies'
#
# Generated by: Commvault
#
# Generated on: 5/22/2019
#

using module 'Commvault.TypeDefinitions'

Set-StrictMode -Version latest


function Get-CVSchedulePolicy {
<#
.SYNOPSIS
    Method to retrieve schedule policies from the CommServe.

.DESCRIPTION
    Method to retrieve schedule policies from the CommServe. Output can be filtered by client/subclient or by policy name or id.

.PARAMETER Name
    Filter output by policy Name.

.PARAMETER Id
    Filter output by policy Id.

.PARAMETER ClientName
    Filter output by ClientName associated with SubclientName.

.PARAMETER SubclientName
    Filter output by SubclientName.

.PARAMETER Scheduletype
    Filter by ScheduleType: DataProtection (default), AuxiliaryCopy, BackupCopy, OfflineContentIndexing, DDBVerification, ContentIndexing, Workflow.

.EXAMPLE
    Get-CVSchedulePolicy
    
.EXAMPLE
    Get-CVSchedulePolicy -Name AuditDB-3

.EXAMPLE
    Get-CVSchedulePolicy -Id 238

.EXAMPLE
    Get-CVSchedulePolicy -SubclientName AuditDB -ClientName carbonwincs1

.EXAMPLE
    Get-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB | Format-List

.EXAMPLE
    Get-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB | Select-Object -ExpandProperty associations

.EXAMPLE
    Get-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB | Select-Object -ExpandProperty task

.EXAMPLE
    Get-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB | Select-Object -ExpandProperty appGroup

.EXAMPLE
    Get-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB | Select-Object -ExpandProperty subTasks

.OUTPUTS
    Outputs [PSCustomObject] containing schedule policy instances.

.NOTES
    Author: Gary Stoops
    Company: Commvault
#>
    [CmdletBinding(DefaultParameterSetName = 'Default')]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $ClientName,

        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $SubclientName,

        [Parameter(Mandatory = $False, ParameterSetName = 'ByName')]
        [ValidateNotNullorEmpty()]
        [String] $Name,

        [Parameter(Mandatory = $False, ParameterSetName = 'ById')]
        [ValidateNotNullorEmpty()]
        [Int32] $Id,

        [Parameter(Mandatory = $False)]
        [CVSchedulePolicyType] $ScheduleType = 'DataProtection'
    )
    
    begin { Write-Debug -Message "$($MyInvocation.MyCommand): begin"

        try {
            $sessionObj = Get-CVSessionDetail $MyInvocation.MyCommand.Name
            $processCount = 0
        }
        catch {
            throw $_
        }
    }

    process { Write-Debug -Message "$($MyInvocation.MyCommand): process"
    
        try {
            if ($PSCmdlet.ParameterSetName -eq 'BySubclient') {
                $subclientObj = Get-CVSubclient -Name $SubclientName -ClientName $ClientName
                if ($null -ne $subclientObj) { 
                    $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{subclientId}', $subclientObj.subclientId)
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): subclient not found having name [$SubclientName]"      
                    return
                }
            }

            # use of {scheduleType} param results in empty response body
            #$sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{scheduleType}', $ScheduleType.value__)
            $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{scheduleType}', $null)
            $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{subclientId}', $null)

            $headerObj = Get-CVRESTHeader $sessionObj
            $body = ''
            $payload = @{ }
            $payload.Add("headerObject", $headerObj)
            $payload.Add("body", $body)
            $validate = 'taskDetail'
                
            $response = Submit-CVRESTRequest $payload $validate

            if ($response.IsValid) {
                foreach ($policy in $response.Content.taskDetail) {
                    if ($PSCmdlet.ParameterSetName -eq 'ByName') {
                        if ($Name -ne $policy.task.taskName) { 
                            continue
                        }
                    }
                    elseif ($PSCmdlet.ParameterSetName -eq 'ById') {
                        if ($Id -ne $policy.task.taskId) { 
                            continue
                        }
                    }
    
                    $sessionObj = Get-CVSessionDetail 'GetSchedulePolicyDetails'
                    $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{schedulePolicyId}', $policy.task.taskId)

                    $headerObj = Get-CVRESTHeader $sessionObj
                    $payload.Clear()
                    $payload.Add("headerObject", $headerObj)
                    $payload.Add("body", $body)
                    $validate = 'taskInfo'
                        
                    $response = Submit-CVRESTRequest $payload $validate
        
                    if ($response.IsValid) {
                        Write-Output $response.Content.taskInfo 
                        $processCount++
                    }
                }
            }
        }
        catch {
            throw $_
        }
    }

    end { Write-Debug -Message "$($MyInvocation.MyCommand): end"

        try {
            if ($processCount -eq 0) {
                if ($PSCmdlet.ParameterSetName -eq 'ByName') {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy not found having name [$Name]"
                }
                elseif ($PSCmdlet.ParameterSetName -eq 'ById') {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy not found having id [$Id]"
                }
                elseif ($PSCmdlet.ParameterSetName -eq 'BySubclient') {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): no policies found for subclient [$SubclientName]"
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): no policies found"
                }
            }
        }
        catch {
            throw $_
        }
    }
}
    
    
function Enable-CVSchedulePolicy {
<#
.SYNOPSIS
    Method to enable a schedule policy on the CommServe.

.DESCRIPTION
    Method to enable a schedule policy on the CommServe.

.PARAMETER Name
    Specify the schedule policy to be enabled by Name.

.PARAMETER Id
    Specify the schedule policy to be enabled by Id (taskId).

.PARAMETER ClientName
    Specify the ClientName associated with SubclientName.

.PARAMETER SubclientName
    Specify the SubclientName.

.PARAMETER PolicyObject
    Specify the schedule policy to be enabled by piping the PolicyObject.

.EXAMPLE
    Enable-CVSchedulePolicy (This will prompt for Name)
    
.EXAMPLE
    Enable-CVSchedulePolicy -Name AuditDB-SchedulePolicy

.EXAMPLE
    Enable-CVSchedulePolicy -Id 229

.EXAMPLE
    Enable-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB (Enables all schedule policies associated with the subclient AuditDB)

.EXAMPLE
    Get-CVSchedulePolicy | Enable-CVSchedulePolicy (Enables all schedule policies on the CommServe)

.OUTPUTS
    Outputs [PSCustomObject] containing task submission result.

.NOTES
    Author: Gary Stoops
    Company: Commvault
#>
    [CmdletBinding(DefaultParameterSetName = 'ByPolicyName')]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyName')]
        [ValidateNotNullorEmpty()]
        [String] $Name,

        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyId')]
        [ValidateNotNullorEmpty()]
        [Int32] $Id,

        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyObject', ValueFromPipeline = $True, ValueFromPipelineByPropertyName = $True)]
        [ValidateNotNullorEmpty()]
        [System.Object] $PolicyObject,

        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $ClientName,

        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $SubclientName,

        [Parameter(DontShow)]
        [Switch] $Disable
    )
    
    begin { Write-Debug -Message "$($MyInvocation.MyCommand): begin"

        try {
            $sessionObj = Get-CVSessionDetail $MyInvocation.MyCommand.Name
            $endpointSave = $sessionObj.requestProps.endpoint
        }
        catch {
            throw $_
        }
    }

    process { Write-Debug -Message "$($MyInvocation.MyCommand): process"
    
        try {
            $policiesToProcess = @()

            if ($PSCmdlet.ParameterSetName -eq 'ByPolicyName') {
                $policyObj = Get-CVSchedulePolicy -Name $Name
                if ($null -ne $policyObj) {
                    $policiesToProcess += $policyObj
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy not found having name [$Name]"
                    return
                }
            }
            elseif ($PSCmdlet.ParameterSetName -eq 'ByPolicyId') {
                $policyObj = Get-CVSchedulePolicy -Id $Id
                if ($null -ne $policyObj) {
                    $policiesToProcess += $policyObj
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy not found having id [$Id]"
                    return
                }
            }
            elseif ($PSCmdlet.ParameterSetName -eq 'BySubclient') {
                $policyObjs = Get-CVSchedulePolicy -ClientName $ClientName -SubclientName $SubclientName
                foreach ($policyObj in $policyObjs) {
                    $policiesToProcess += $policyObj
                }
            }
            else { #ByPolicyObject
                $policiesToProcess += $PolicyObject
            }

            foreach ($policy in $policiesToProcess) {
                if ($Disable) {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): ...disabling policy [$($policy.task.taskName)] taskId [$($policy.task.taskId)]"
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): ...enabling policy [$($policy.task.taskName)] taskId [$($policy.task.taskId)]"
                }

                $sessionObj.requestProps.endpoint = $endpointSave
                $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{schedulePolicyId}', $policy.task.taskId)

                if ($Disable) { $body = (PrepareUpdateScheduleTaskBodyJson $policy -Disable).body }
                else { $body = (PrepareUpdateScheduleTaskBodyJson $policy).body }
    
                $headerObj = Get-CVRESTHeader $sessionObj
                $payload = @{ }
                $payload.Add("headerObject", $headerObj)
                $payload.Add("body", $body)
                $validate = $null
                    
                $response = Submit-CVRESTRequest $payload $validate
    
                if ($response.IsValid) {
                    Write-Output $response.Content
                }
                else {
                    if ($Disable) {
                        Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy [$($policy.task.taskName)] taskId [$($policy.task.taskId)] was not disabled"
                    }
                    else {
                        Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): policy [$($policy.task.taskName)] taskId [$($policy.task.taskId)] was not enabled"
                    }
                }
            }
        }
        catch {
            throw $_
        }
    }

    end { Write-Debug -Message "$($MyInvocation.MyCommand): end"
    }
}
            
            
function Disable-CVSchedulePolicy {
<#
.SYNOPSIS
    Method to disable a schedule policy on the CommServe.

.DESCRIPTION
    Method to disable a schedule policy on the CommServe.

.PARAMETER Name
    Specify the schedule policy to be disabled by Name.

.PARAMETER Id
    Specify the schedule policy to be disabled by Id (taskId).

.PARAMETER ClientName
    Specify the ClientName associated with SubclientName.

.PARAMETER SubclientName
    Specify the SubclientName.

.PARAMETER PolicyObject
    Specify the schedule policy to be disabled by piping the PolicyObject.

.EXAMPLE
    Disable-CVSchedulePolicy (This will prompt for Name)
    
.EXAMPLE
    Disable-CVSchedulePolicy -Name AuditDB-SchedulePolicy

.EXAMPLE
    Disable-CVSchedulePolicy -Id 229

.EXAMPLE
    Disable-CVSchedulePolicy -ClientName carbonWinCS1 -SubclientName AuditDB (Disables all schedule policies associated with the subclient AuditDB)

.EXAMPLE
    Get-CVSchedulePolicy | Disable-CVSchedulePolicy (Disables all schedule policies on the CommServe)

.OUTPUTS
    Outputs [PSCustomObject] containing task submission result.

.NOTES
    Author: Gary Stoops
    Company: Commvault
#>
    [CmdletBinding(DefaultParameterSetName = 'ByPolicyName')]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyName')]
        [ValidateNotNullorEmpty()]
        [String] $Name,

        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyId')]
        [ValidateNotNullorEmpty()]
        [Int32] $Id,

        [Parameter(Mandatory = $True, ParameterSetName = 'ByPolicyObject', ValueFromPipeline = $True, ValueFromPipelineByPropertyName = $True)]
        [ValidateNotNullorEmpty()]
        [System.Object] $PolicyObject,

        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $ClientName,

        [Parameter(Mandatory = $True, ParameterSetName = 'BySubclient')]
        [ValidateNotNullorEmpty()]
        [String] $SubclientName
    )

    begin { Write-Debug -Message "$($MyInvocation.MyCommand): begin"
    }

    process { Write-Debug -Message "$($MyInvocation.MyCommand): process"
    
        try {
            if ($PSCmdlet.ParameterSetName -eq 'ByPolicyName') {
                Enable-CVSchedulePolicy -Name $Name -Disable
            }
            elseif ($PSCmdlet.ParameterSetName -eq 'ByPolicyId') {
                Enable-CVSchedulePolicy -Id $Id -Disable
            }
            elseif ($PSCmdlet.ParameterSetName -eq 'BySubclient') {
                Enable-CVSchedulePolicy -ClientName $ClientName -SubclientName $SubclientName -Disable
            }
            else {
                $PolicyObject | Enable-CVSchedulePolicy -Disable
            }
        }
        catch {
            throw $_
        }
    }

    end { Write-Debug -Message "$($MyInvocation.MyCommand): end"
    }
}
                
                
function Get-CVStoragePolicy {
<#
.SYNOPSIS
    Method to retrieve storage policies from the CommServe.

.DESCRIPTION
    Method to retrieve storage policies from the CommServe. Output can be filtered by media agent and policy Name.
    Note: detail information is

.PARAMETER Name
    Specify storage policy instances to be output by Name.

.PARAMETER MediaAgentName
    Specify storage policy instances to be output by MediaAgentName.

.PARAMETER MediaAgentObject
    Specify storage policy instances to be output pipeline input of MediaAgentObject.

.PARAMETER AllProperties
    Output AllProperties for each schedule policy.

.EXAMPLE
    Get-CVStoragePolicy
    
.EXAMPLE
    Get-CVStoragePolicy -AllProperties | Select-Object -ExpandProperty copy

.EXAMPLE
    Get-CVStoragePolicy -Name ACPLAN

.EXAMPLE
    Get-CVStoragePolicy -Name ACPLAN -MediaAgentName carbonwincs1 -AllProperties

.EXAMPLE
    Get-CVMediaAgent | Get-CVStoragePolicy

.EXAMPLE
    Get-CVMediaAgent | Get-CVStoragePolicy -Name ACPLAN

.OUTPUTS
    Outputs [PSCustomObject] containing storage policy instances.

.NOTES
    Author: Gary Stoops
    Company: Commvault
#>
[CmdletBinding(DefaultParameterSetName = 'Default')]
    [OutputType([PSCustomObject])]
    param(
        [Parameter(Mandatory = $False)]
        [ValidateNotNullorEmpty()]
        [String] $Name,
    
        [Parameter(Mandatory = $False, ParameterSetName = 'ByName')]
        [ValidateNotNullorEmpty()]
        [String] $MediaAgentName,
    
        [Parameter(Mandatory = $False, ParameterSetName = 'ByObject', ValueFromPipeline = $True, ValueFromPipelineByPropertyName = $True)]
        [ValidateNotNullorEmpty()]
        [System.Object] $MediaAgentObject,

        [Parameter(Mandatory = $False)]
        [Switch] $AllProperties
    )
   
    begin { Write-Debug -Message "$($MyInvocation.MyCommand): begin"

        try {
            if ($PSCmdlet.ParameterSetName -eq 'ByName' -or $PSCmdlet.ParameterSetName -eq 'ByObject') {
                $sessionObj = Get-CVSessionDetail 'GetMediaAgentStoragePolicies'
            }
            else {
                $sessionObj = Get-CVSessionDetail $MyInvocation.MyCommand.Name
            }
            $endpointSave = $sessionObj.requestProps.endpoint
            $outputCount = 0
        }
        catch {
            throw $_
        }
    }
    
    process { Write-Debug -Message "$($MyInvocation.MyCommand): process"
    
        try {
            $sessionObj.requestProps.endpoint = $endpointSave

            if ($PSCmdlet.ParameterSetName -eq 'ByName') {
                $mediaAgentObj = Get-CVMediaAgent -Name $MediaAgentName
                if ($null -ne $mediaAgentObj) {
                    $MediaAgentObject = $mediaAgentObj
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): media agent not found having name [$MediaAgentName]"
                    return
                }
            }

            if ($PSCmdlet.ParameterSetName -eq 'ByName' -or $PSCmdlet.ParameterSetName -eq 'ByObject') {
                $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{mediaAgentId}', $MediaAgentObject.Id)
                $validate = 'storagePolicyInformationAssociatedToMA'
            }
            else {
                $validate = 'policies'
            }

            $headerObj = Get-CVRESTHeader $sessionObj
            $body = ''
            $payload = @{ }
            $payload.Add("headerObject", $headerObj)
            $payload.Add("body", $body)
                
            $response = Submit-CVRESTRequest $payload $validate

            if ($response.IsValid) {
                $policiesToProcess = @()
                if ($PSCmdlet.ParameterSetName -eq 'ByName' -or $PSCmdlet.ParameterSetName -eq 'ByObject') {
                    foreach ($policy in $response.Content.storagePolicyInformationAssociatedToMA) {
                        if (-not [String]::IsNullOrEmpty($Name)) {
                            if ($Name -eq $policy.storagePolicyAndCopy.storagePolicyName) {
                                $policiesToProcess += $policy
                            }
                        }
                        else {
                            $policiesToProcess += $policy
                        }
                    }
                }
                else {
                    foreach ($policy in $response.Content.policies) {
                        if (-not [String]::IsNullOrEmpty($Name)) {
                            if ($Name -eq $policy.storagePolicyName) {
                                $policiesToProcess += $policy
                            }
                        }
                        else {
                            $policiesToProcess += $policy
                        }
                    }
                }
                foreach ($policy in $policiesToProcess) {
                    if ($AllProperties) {
                        $sessionObj = Get-CVSessionDetail 'GetStoragePolicyDetails'

                        if ($PSCmdlet.ParameterSetName -eq 'ByName' -or $PSCmdlet.ParameterSetName -eq 'ByObject') {
                            $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{storagePolicyId}', $policy.storagePolicyAndCopy.storagePolicyId)
                        }
                        else {
                            $sessionObj.requestProps.endpoint = $sessionObj.requestProps.endpoint -creplace ('{storagePolicyId}', $policy.storagePolicyId)
                        }

                        $headerObj = Get-CVRESTHeader $sessionObj
                        $payload.Clear()
                        $payload.Add("headerObject", $headerObj)
                        $payload.Add("body", $body)
                        $validate = 'storagePolicy'
                            
                        $response = Submit-CVRESTRequest $payload $validate
            
                        if ($response.IsValid) {
                            Write-Output $response.Content
                            $outputCount++
                        }
                        else {
                            Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): details not found for policy [$($policy.storagePolicyAndCopy.storagePolicyName)]"
                        }
                    }
                    else {
                        Write-Output $policy
                        $outputCount++
                    }
                }
            }
            elseif ($PSCmdlet.ParameterSetName -eq 'ByObject') {
                Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): no storage policies found for media agent [$($MediaAgentObject.Name)]"
            }
        }
        catch {
            throw $_
        }
    }

    end { Write-Debug -Message "$($MyInvocation.MyCommand): end"

        try {
            if ($outputCount -eq 0) {
                if (-not [String]::IsNullOrEmpty($Name)) {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): storage policy not found having name [$Name]"
                }
                else {
                    Write-Information -InformationAction Continue -MessageData "INFO: $($MyInvocation.MyCommand): no storage policies found"
                }
            }
        }
        catch {
            throw $_
        }
    }
}


<# PrepareUpdateScheduleTaskBodyJson
{
    "processinginstructioninfo": {
        "locale": {
            "_type_": 66,
            "localeId": 0
        },
        "formatFlags": {
            "skipIdToNameConversion": true
        },
        "user": {
            "userName": "",
            "userId": 1,
            "_type_": 13
        }
    },
    "taskInfo": {
        "associations": [
            {
                "srmReportSet": 0,
                "srmTemplateId": 0,
                "subclientId": 7,
                "clientGroupId": 0,
                "storagePolicyId": 0,
                "copyId": 0,
                "applicationId": 81,
                "clientName": "carbonwincs1",
                "displayName": "carbonwincs1",
                "backupsetId": 6,
                "instanceId": 3,
                "clientId": 2,
                "copyName": "",
                "subclientName": "AuditDB",
                "srmTemplateName": "",
                "agentlessPolicyId": 0,
                "mediaAgentId": 0,
                "mediaAgentName": "carbonwincs1",
                "backupsetName": "defaultBackupSet",
                "instanceName": "CARBONWINCS1\\COMMVAULT",
                "storagePolicyName": "",
                "_type_": 7,
                "appName": "SQL Server",
                "flags": {
                    "exclude": false
                }
            }
        ],
        "task": {
            "description": "Audit DB schedule policy.",
            "ownerId": 3,
            "runUserId": 1,
            "taskType": 4,
            "ownerName": "master",
            "alertId": 0,
            "GUID": "db565d1f-6b76-4596-bf6f-b1a0091e1ac9",
            "policyType": 0,
            "taskName": "AuditDB-SchedulePolicy",
            "taskId": 229,
            "originalCC": {
                "commCellId": 2
            },
            "taskFlags": {
                "isEdgeDrive": false,
                "isEZOperation": false,
                "uninstalled": false,
                "disabled": true
            },
            "task": {
                "taskName": "AuditDB-SchedulePolicy",
                "taskId": 229
            }
        },
        "appGroup": {},
        "subTasks": [
            {
                "relativeTime": 49072,
                "nextScheduleTime": 1564718400,
                "subTask": {
                    "subTaskOrder": 0,
                    "subTaskName": "",
                    "subTaskType": 2,
                    "flags": 0,
                    "operationType": 2,
                    "subTaskId": 230
                },
                "pattern": {
                    "active_end_occurence": 0,
                    "freq_subday_interval": 0,
                    "freq_type": 4,
                    "patternId": 17,
                    "flags": 0,
                    "description": "Every day at 9:00 PM  ",
                    "active_end_time": 0,
                    "active_end_date": 0,
                    "skipOccurence": 0,
                    "skipDayNumber": 0,
                    "active_start_time": 75600,
                    "freq_restart_interval": 0,
                    "active_start_date": 1564444800,
                    "freq_interval": 1,
                    "freq_relative_interval": 0,
                    "name": "",
                    "freq_recurrence_factor": 1,
                    "repeatPattern": [
                        {
                            "exception": true,
                            "onDayNumber": 0,
                            "onDay": 512,
                            "description": "On First - Weekend Day",
                            "occurrence": 1,
                            "repeatOn": 0
                        }
                    ],
                    "calendar": {
                        "calendarId": 1
                    },
                    "timeZone": {
                        "TimeZoneID": 64
                    }
                },
                "options": {
                    "backupOpts": {
                        "truncateLogsOnSource": false,
                        "sybaseSkipFullafterLogBkp": false,
                        "bkpLatestVersion": true,
                        "notSynthesizeFullFromPrevBackup": false,
                        "collectMetaInfo": false,
                        "backupLevel": 2,
                        "incLevel": 1,
                        "adHocBackup": false,
                        "runIncrementalBackup": false,
                        "runSILOBackup": false,
                        "doNotTruncateLog": true,
                        "vsaBackupOptions": {
                            "backupFailedVMsOnly": false
                        },
                        "cdrOptions": {
                            "incremental": true,
                            "moveConsistencyPointToTape": false,
                            "cdrRecoveryPointType": 0,
                            "createRecoveryPoint": false,
                            "dataVerificationOnly": false,
                            "full": false
                        },
                        "dataOpt": {
                            "skipCatalogPhaseForSnapBackup": true,
                            "useCatalogServer": true,
                            "followMountPoints": true,
                            "enforceTransactionLogUsage": false,
                            "skipConsistencyCheck": false,
                            "granularrecovery": false,
                            "collectVMGranularRecoveryMetadataForBkpCopy": false,
                            "createNewIndex": false,
                            "autoCopy": false
                        },
                        "oracleOptions": {
                            "level": 1,
                            "cumulative": false,
                            "deleteArchLogOptions": {
                                "backupArchiveLogCriteria": 0
                            },
                            "backupArchLogOptions": {
                                "backupArchiveLogCriteria": 7,
                                "startLSN": 1,
                                "endLSN": 1,
                                "backupArchiveLog": true
                            }
                        },
                        "distAppsBackupOptions": {
                            "runLogBkp": false,
                            "runDataBkp": true
                        },
                        "mediaOpt": {}
                    },
                    "adminOpts": {
                        "contentIndexingOption": {
                            "subClientBasedAnalytics": false
                        }
                    },
                    "restoreOptions": {
                        "commonOptions": {
                            "syncRestore": false
                        }
                    },
                    "commonOpts": {
                        "perfJobOpts": {}
                    }
                }
            }
        ]
    }
}
#>
function PrepareUpdateScheduleTaskBodyJson ([PSCustomObject] $TaskInfo, [Switch] $Disable) {

    try {
        $createTaskReq = [ordered] @{ }

        $processingInstructionInfo = [ordered]@{ }
        $locale = @{ }
        $locale.Add('_type_', 66)
        $locale.Add('localeId', 0)
        $formatFlags = @{ }
        $formatFlags.Add('skipIdToNameConversion', $True)
        $user = @{ }
        $user.Add('_type_', 13)
        $user.Add('userName', '')
        $user.Add('userId', 1)
        $processingInstructionInfo.Add('locale', $locale)
        $processingInstructionInfo.Add('formatFlags', $formatFlags)
        $processingInstructionInfo.Add('user', $user)

        $TaskInfo.task.taskFlags.disabled = $Disable.IsPresent

        $createTaskReq.Add('processinginstructioninfo', $processingInstructionInfo)
        $createTaskReq.Add('taskInfo', $TaskInfo)

        $body = $createTaskReq | ConvertTo-Json -Depth 10
        return @{ 'body' = $body }
    }
    catch {
        throw $_
    }
}